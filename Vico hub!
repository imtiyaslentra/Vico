local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")
local BallFolder = Workspace:WaitForChild("Balls")

local player = Players.LocalPlayer
local canParry = false  -- Akan diubah melalui toggle
local canSpam = false   -- Akan diubah melalui toggle
local notificationCooldown = false -- Membatasi pengiriman notifikasi
local parrySuccess = false -- Menghindari spam notifikasi saat Autoparry berhasil
local spamSuccess = false -- Menghindari spam notifikasi saat Autospam berhasil

-- Membuat jendela untuk OrionLib
local OrionLib = loadstring(game:HttpGet("https://raw.githubusercontent.com/shlexware/Orion/main/source"))()
local Window = OrionLib:MakeWindow({Name = "Vico Hub | Integrated", IntroText = "Vico Noob", HidePremium = false})

local Tab = Window:MakeTab({
	Name = "Main",
	Icon = "rbxassetid://4483345998",
	PremiumOnly = false
})

-- Toggle untuk AutoParry
Tab:AddToggle({
    Name = "Auto Parry",
    Default = false,
    Callback = function(state)
        canParry = state
        if state then
            print("Auto Parry Enabled")
            OrionLib:MakeNotification({
                Name = "Auto Parry",
                Content = "Auto Parry has been enabled.",
                Time = 5
            })
        else
            print("Auto Parry Disabled")
            OrionLib:MakeNotification({
                Name = "Auto Parry",
                Content = "Auto Parry has been disabled.",
                Time = 5
            })
        end
    end
})

-- Toggle untuk AutoSpam
Tab:AddToggle({
    Name = "Auto Spam",
    Default = false,
    Callback = function(state)
        canSpam = state
        if state then
            print("Auto Spam Enabled")
            OrionLib:MakeNotification({
                Name = "Auto Spam",
                Content = "Auto Spam has been enabled.",
                Time = 5
            })
        else
            print("Auto Spam Disabled")
            OrionLib:MakeNotification({
                Name = "Auto Spam",
                Content = "Auto Spam has been disabled.",
                Time = 5
            })
        end
    end
})

-- Fungsi untuk membatasi notifikasi agar tidak terlalu sering
local function sendNotification(name, content)
    if not notificationCooldown then
        OrionLib:MakeNotification({
            Name = name,
            Content = content,
            Time = 5
        })
        notificationCooldown = true
        task.delay(1, function() -- Delay 1 detik untuk cooldown notifikasi
            notificationCooldown = false
        end)
    end
end

-- Fungsi untuk menghitung waktu prediksi bola
local function calculatePredictionTime(ball)
    local character = player.Character
    if character then
        local rootPart = character:FindFirstChild("HumanoidRootPart")
        if rootPart then
            local relativePosition = ball.Position - rootPart.Position
            local relativeVelocity = ball.Velocity

            local distance = relativePosition.Magnitude
            local speed = relativeVelocity.Magnitude

            if speed > 0 then      
                return distance / speed
            end
        end
    end
    return math.huge 
end

-- Fungsi untuk melakukan Parry
local function parry()
    if canParry and not parrySuccess then
        canParry = false
        parrySuccess = true
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)

        task.delay(0.1, function()
            print("Parried!")
            sendNotification("Auto Parry", "Parry was successful.")
            canParry = true
            parrySuccess = false
        end)
    elseif not canParry then
        sendNotification("Auto Parry", "Parry failed due to cooldown or error.")
    end
end

-- Fungsi untuk melakukan Spam
local function spam()
    if canSpam and not spamSuccess then
        canSpam = false
        spamSuccess = true
        -- Contoh mekanisme spam
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Space, false, game)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Space, false, game)

        task.delay(0.1, function()
            print("Spam Executed!")
            sendNotification("Auto Spam", "Spam was successful.")
            canSpam = true
            spamSuccess = false
        end)
    elseif not canSpam then
        sendNotification("Auto Spam", "Spam failed due to cooldown or error.")
    end
end

-- Fungsi untuk memeriksa kedekatan bola dengan pemain dan memicu parry atau spam
local function checkProximityToPlayer(ball)
    local predictionTime = calculatePredictionTime(ball)
    local realBallAttribute = ball:GetAttribute("realBall")
    local target = ball:GetAttribute("target")

    if predictionTime and realBallAttribute and target then
        if target == player.Name then
            local ballSpeedThreshold = math.max(0.4, 0.6 - ball.Velocity.Magnitude * 0.03)

            if predictionTime <= ballSpeedThreshold then
                if canParry then
                    parry()
                elseif canSpam and not canParry then
                    spam() -- Memastikan bahwa spam hanya terjadi jika parry tidak aktif
                end
            end
        end
    end
end

-- Fungsi untuk memeriksa bola di sekitar pemain
local function checkBallsProximity()
    for _, ball in ipairs(BallFolder:GetChildren()) do
        if ball:IsA("BasePart") then
            checkProximityToPlayer(ball)
        end
    end
end

-- Menjalankan pengecekan proximity secara berkala
RunService.Heartbeat:Connect(function()
    checkBallsProximity()
end)

-- Menginisialisasi OrionLib
OrionLib:Init()
