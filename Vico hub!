-- Membuat jendela untuk OrionLib
local OrionLib = loadstring(game:HttpGet("https://raw.githubusercontent.com/shlexware/Orion/main/source"))()
local Window = OrionLib:MakeWindow({Name = "Vico Hub | Integrated", IntroText = "Vico Noob", HidePremium = false})

local Tab = Window:MakeTab({
	Name = "Main",
	Icon = "rbxassetid://4483345998",
	PremiumOnly = false
})

-- Toggle untuk AutoParry
Tab:AddToggle({
    Name = "Auto Parry",
    Default = false,
    Callback = function(state)
        -- Mengatur status parry
        canParry = state
        
        if state then
            print("Auto Parry Enabled")
            OrionLib:MakeNotification({
                Name = "Auto Parry",
                Content = "Auto Parry has been enabled.",
                Time = 5
            })

            RunService.Heartbeat:Connect(function()
                for _, ball in ipairs(BallFolder:GetChildren()) do
                    checkProximityToPlayer(ball)
                end
            end)

        else
            print("Auto Parry Disabled")
            OrionLib:MakeNotification({
                Name = "Auto Parry",
                Content = "Auto Parry has been disabled.",
                Time = 5
            })
            
        end
    end
})

-- Toggle untuk AutoSpam
Tab:AddToggle({
    Name = "Auto Spam (In Progress)",
    Default = false,
    Callback = function(state)
        canSpam = state
        if state then
            print("Auto Spam Enabled")
            OrionLib:MakeNotification({
                Name = "Auto Spam",
                Content = "Auto Spam has been enabled.",
                Time = 5
            })
        else
            print("Auto Spam Disabled")
            OrionLib:MakeNotification({
                Name = "Auto Spam",
                Content = "Auto Spam has been disabled.",
                Time = 5
            })
        end
    end
})

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")
local BallFolder = Workspace:WaitForChild("Balls")

local player = Players.LocalPlayer
local canParry = true

-- Konfigurasi optimal parry
local predictionMultiplier = 0.8  -- Adjust ini untuk mengoptimalkan prediksi
local maxParryDistance = 50  -- Maksimal jarak untuk parry
local ballAccelerationThreshold = 0.5  -- Threshold untuk akselerasi bola

-- Fungsi untuk menghitung waktu prediksi yang lebih presisi
local function calculatePredictionTime(ball)
    local character = player.Character
    if character then
        local rootPart = character:FindFirstChild("HumanoidRootPart")
        if rootPart then
            local relativePosition = ball.Position - rootPart.Position
            local relativeVelocity = ball.Velocity

            local distance = relativePosition.Magnitude
            local speed = relativeVelocity.Magnitude

            if speed > 0 then
                local predictedTime = distance / speed * predictionMultiplier  -- Optimasi dengan pengali prediksi
                return predictedTime, distance, speed
            end
        end
    end
    return math.huge, math.huge, 0  -- Jika bola diam atau tidak ada kecepatan
end

-- Fungsi baru untuk mendeteksi arah bola dan akselerasinya
local function detectBallAcceleration(ball)
    local lastVelocity = ball:GetAttribute("lastVelocity") or Vector3.new(0, 0, 0)
    local currentVelocity = ball.Velocity

    local acceleration = (currentVelocity - lastVelocity).Magnitude / RunService.Heartbeat:Wait()
    ball:SetAttribute("lastVelocity", currentVelocity)

    return acceleration
end

local function parry()
    if canParry then
        canParry = false
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
        
        task.delay(0.1, function()
            print("parried successfully")
            canParry = true
        end)
    end
end

-- Optimalisasi checkProximityToPlayer dengan tambahan parameter kecepatan dan akselerasi
local function checkProximityToPlayer(ball)
    local predictionTime, distance, speed = calculatePredictionTime(ball)
    local acceleration = detectBallAcceleration(ball)
    local realBallAttribute = ball:GetAttribute("realBall")
    local target = ball:GetAttribute("target")

    if realBallAttribute and target == player.Name then
        local ballSpeedThreshold = math.max(0.4, 0.6 - speed * 0.03)
        local withinParryRange = distance <= maxParryDistance
        local accelerationCheck = acceleration <= ballAccelerationThreshold

        -- Hanya lakukan parry jika waktu prediksi, jarak, dan akselerasi memenuhi syarat
        if predictionTime <= ballSpeedThreshold and withinParryRange and accelerationCheck then
            parry()
        end
    end
end

-- Heartbeat untuk terus memantau bola
RunService.Heartbeat:Connect(function()
    for _, ball in ipairs(BallFolder:GetChildren()) do
        checkProximityToPlayer(ball)
    end
end)

OrionLib:Init()
